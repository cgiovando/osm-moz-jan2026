<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mozambique Flood Mapping - Coordinated OSM Response</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/pmtiles@3.0.3/dist/pmtiles.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; }

        .container { display: flex; height: 100vh; }

        .sidebar {
            width: 280px;
            background: #16213e;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        h1 { font-size: 1.4em; color: #4ecca3; margin-bottom: 5px; }
        .subtitle { font-size: 0.85em; color: #888; margin-bottom: 20px; line-height: 1.4; }

        .stat-card {
            background: #1a1a2e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .stat-value { font-size: 1.8em; font-weight: bold; color: #4ecca3; }
        .stat-label { font-size: 0.8em; color: #888; }

        .section-title {
            font-size: 0.75em;
            text-transform: uppercase;
            color: #666;
            margin: 20px 0 10px;
            letter-spacing: 1px;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #1a1a2e;
            border-radius: 6px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .layer-toggle:hover { background: #2a2a4a; }
        .layer-toggle.inactive { opacity: 0.4; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 10px; }
        .layer-name { flex: 1; font-size: 0.9em; }
        .layer-count { font-size: 0.8em; color: #4ecca3; }

        .download-link {
            display: block;
            color: #4ecca3;
            text-decoration: none;
            font-size: 0.85em;
            padding: 5px 0;
        }
        .download-link:hover { text-decoration: underline; }

        .main-content { flex: 1; display: flex; flex-direction: column; }

        #timeline {
            background: #16213e;
            padding: 15px 20px;
            border-bottom: 1px solid #2a2a4a;
        }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timeline-title { font-weight: 600; }
        .timeline-hint { font-size: 0.8em; color: #666; }
        .selected-date { color: #4ecca3; font-weight: 600; }

        .chart-container { position: relative; height: 100px; }
        .y-axis { position: absolute; left: -45px; top: 0; bottom: 0; width: 40px; }
        .y-label { position: absolute; right: 5px; font-size: 9px; color: #555; transform: translateY(-50%); }
        .gridlines { position: absolute; left: 0; right: 0; top: 0; bottom: 0; pointer-events: none; }
        .gridline { position: absolute; left: 0; right: 0; border-top: 1px solid #2a2a4a; }
        .gridline.major { border-top-color: #3a3a5a; }

        .bar-chart { display: flex; align-items: flex-end; height: 100%; gap: 2px; width: 100%; position: relative; z-index: 1; }
        .bar {
            background: linear-gradient(to top, #4ecca3, #45b39d);
            flex: 1;
            min-width: 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 2px 2px 0 0;
        }
        .bar:hover { background: linear-gradient(to top, #5ddbaf, #4ecca3); }
        .bar.selected { background: linear-gradient(to top, #f39c12, #e67e22); }
        .bar.dimmed { opacity: 0.3; }

        .x-axis { display: flex; justify-content: space-between; margin-top: 5px; padding: 0 10px; }
        .x-label { font-size: 10px; color: #666; }

        /* Animation controls */
        .animation-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            padding: 10px;
            background: #1a1a2e;
            border-radius: 6px;
        }
        .play-btn {
            background: #4ecca3;
            color: #1a1a2e;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
        }
        .play-btn:hover { background: #5ddbaf; }
        .play-btn.playing { background: #e74c3c; }
        .time-slider {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: #2a2a4a;
            border-radius: 3px;
            outline: none;
        }
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #4ecca3;
            border-radius: 50%;
            cursor: pointer;
        }
        .current-time {
            font-size: 0.85em;
            color: #4ecca3;
            min-width: 140px;
            text-align: right;
        }

        #map { flex: 1; }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(22, 33, 62, 0.9);
            padding: 20px 40px;
            border-radius: 8px;
            z-index: 1000;
        }

        .ai-disclaimer {
            margin-top: auto;
            padding-top: 15px;
            font-size: 10px;
            color: #666;
            text-align: center;
            border-top: 1px solid #2a2a4a;
        }
        .ai-disclaimer a { color: #4ecca3; text-decoration: none; }
        .ai-disclaimer a:hover { text-decoration: underline; }

        .maplibregl-popup-content {
            background: #16213e;
            color: #eee;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.85em;
        }
        .maplibregl-popup-anchor-bottom .maplibregl-popup-tip { border-top-color: #16213e; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Mozambique Flood Response</h1>
            <p class="subtitle">Coordinated OSM mapping in flood-affected areas (Gaza, Sofala, Zambezia provinces) - January 2026</p>

            <div class="stat-card">
                <div class="stat-value" id="total-features">-</div>
                <div class="stat-label">Features Mapped</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-contributors">-</div>
                <div class="stat-label">Contributors</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="peak-edits">-</div>
                <div class="stat-label">Peak Day Edits</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="date-range">-</div>
                <div class="stat-label">Date Range</div>
            </div>

            <div class="section-title">Feature Layers</div>
            <div class="layer-toggle" data-layer="building">
                <div class="color-dot" style="background: #e74c3c;"></div>
                <span class="layer-name">Buildings</span>
                <span class="layer-count" id="count-building">0</span>
            </div>
            <div class="layer-toggle" data-layer="highway">
                <div class="color-dot" style="background: #3498db;"></div>
                <span class="layer-name">Highways</span>
                <span class="layer-count" id="count-highway">0</span>
            </div>
            <div class="layer-toggle" data-layer="waterway">
                <div class="color-dot" style="background: #2ecc71;"></div>
                <span class="layer-name">Waterways</span>
                <span class="layer-count" id="count-waterway">0</span>
            </div>

            <div class="section-title">HOT Projects</div>
            <div class="layer-toggle" data-layer="hot-projects" id="hot-toggle">
                <div class="color-dot" style="background: #f39c12; border: 2px solid #f39c12;"></div>
                <span class="layer-name">Project Areas</span>
                <span class="layer-count" id="count-hot">0</span>
            </div>

            <div class="section-title">Download Data</div>
            <a href="mozambique_flood_mapping.geojson" download class="download-link">OSM Features (GeoJSON)</a>
            <a href="mozambique_flood_mapping.pmtiles" download class="download-link">OSM Features (PMTiles)</a>
            <a href="hot_projects.geojson" download class="download-link">HOT Projects (GeoJSON)</a>
            <a href="mozambique_mapping_stats.json" download class="download-link">Statistics (JSON)</a>

            <div class="ai-disclaimer">
                Built with AI assistance (Claude) · <a href="https://github.com/cgiovando/osm-moz-jan2026" target="_blank">Source</a>
            </div>
        </div>

        <div class="main-content">
            <div id="timeline">
                <div class="timeline-header">
                    <span class="timeline-title">Edits Over Time</span>
                    <span class="timeline-hint">Click a bar to filter by date <span class="selected-date" id="selected-date-label"></span></span>
                </div>
                <div class="chart-container">
                    <div class="y-axis" id="y-axis"></div>
                    <div class="gridlines" id="gridlines"></div>
                    <div class="bar-chart" id="bar-chart"></div>
                </div>
                <div class="x-axis" id="x-axis"></div>
                <div class="animation-controls">
                    <button class="play-btn" id="play-btn">▶ Play</button>
                    <input type="range" class="time-slider" id="time-slider" min="0" max="100" value="100">
                    <span class="current-time" id="current-time">All dates</span>
                </div>
            </div>
            <div id="map">
                <div id="loading">Loading map data...</div>
            </div>
        </div>
    </div>

    <script>
        // Register PMTiles protocol with explicit URL handling
        const PMTILES_URL = new URL('mozambique_flood_mapping.pmtiles', window.location.href).href;
        const p = new pmtiles.PMTiles(PMTILES_URL);

        // Add the protocol
        const protocol = new pmtiles.Protocol();
        maplibregl.addProtocol('pmtiles', protocol.tile);

        // Pre-cache the header
        p.getHeader().then(h => console.log('PMTiles header:', h));

        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'carto-dark': {
                        type: 'raster',
                        tiles: ['https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png'],
                        tileSize: 256,
                        attribution: '© OpenStreetMap contributors © CARTO'
                    }
                },
                layers: [{
                    id: 'carto-dark',
                    type: 'raster',
                    source: 'carto-dark',
                    minzoom: 0,
                    maxzoom: 19
                }]
            },
            center: [33.5, -24.95],
            zoom: 10
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'top-left');

        // State
        let stats = null;
        let hotProjectsBounds = null;
        let activeTypes = { building: true, highway: true, waterway: true };
        let hotProjectsVisible = true;
        let allTimestamps = [];
        let currentTimeFilter = null;
        let isPlaying = false;
        let animationFrame = null;

        // Load stats
        fetch('mozambique_mapping_stats.json')
            .then(r => r.json())
            .then(data => {
                stats = data;
                document.getElementById('total-features').textContent = data.total_features.toLocaleString();
                document.getElementById('total-contributors').textContent = data.unique_contributors.toLocaleString();

                const peakDay = data.edits_by_date.reduce((max, d) => d[1] > max[1] ? d : max, ['', 0]);
                document.getElementById('peak-edits').textContent = peakDay[1].toLocaleString();

                const dates = data.edits_by_date.map(d => d[0]);
                const formatDate = d => {
                    const [y, m, day] = d.split('-');
                    return `${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][parseInt(m)-1]} ${parseInt(day)}, ${y}`;
                };
                document.getElementById('date-range').textContent = `${formatDate(dates[0])} to ${formatDate(dates[dates.length-1])}`;

                // Build timeline
                buildTimeline(data.edits_by_date);

                // Setup time slider
                setupTimeSlider(data.edits_by_date);
            });

        // Build timeline
        function buildTimeline(editsByDate) {
            const maxVal = Math.max(...editsByDate.map(d => d[1]));
            buildYAxis(maxVal);

            const chart = document.getElementById('bar-chart');
            chart.innerHTML = '';

            editsByDate.forEach(([date, count]) => {
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${(count / maxVal) * 100}%`;
                bar.dataset.date = date;
                bar.title = `${date}: ${count.toLocaleString()} edits`;
                bar.addEventListener('click', () => selectDate(date));
                chart.appendChild(bar);
            });

            // X-axis labels
            const xAxis = document.getElementById('x-axis');
            xAxis.innerHTML = '';
            const step = Math.max(1, Math.floor(editsByDate.length / 5));
            for (let i = 0; i < editsByDate.length; i += step) {
                const label = document.createElement('span');
                label.className = 'x-label';
                const [y, m, d] = editsByDate[i][0].split('-');
                label.textContent = `${['Jan','Feb','Mar'][parseInt(m)-1]} ${parseInt(d)}`;
                xAxis.appendChild(label);
            }
        }

        // Build Y-axis
        function buildYAxis(maxVal) {
            const yAxis = document.getElementById('y-axis');
            const gridlines = document.getElementById('gridlines');
            yAxis.innerHTML = '';
            gridlines.innerHTML = '';

            if (maxVal <= 0) return;

            const magnitude = Math.pow(10, Math.floor(Math.log10(maxVal)));
            const normalized = maxVal / magnitude;
            let interval = normalized <= 2 ? magnitude / 5 : normalized <= 5 ? magnitude / 2 : magnitude;
            while (maxVal / interval > 8) interval *= 2;

            for (let val = interval; val <= maxVal; val += interval) {
                const pct = (1 - val / maxVal) * 100;
                const isMajor = val % (interval * 2) === 0 || interval >= 5000;

                const label = document.createElement('div');
                label.className = 'y-label';
                label.style.top = `${pct}%`;
                label.textContent = val >= 1000 ? (val / 1000) + 'k' : val;
                yAxis.appendChild(label);

                const line = document.createElement('div');
                line.className = 'gridline' + (isMajor ? ' major' : '');
                line.style.top = `${pct}%`;
                gridlines.appendChild(line);
            }
        }

        // Select date
        function selectDate(date) {
            document.querySelectorAll('.bar').forEach(bar => {
                bar.classList.remove('selected', 'dimmed');
                if (date && bar.dataset.date !== date) bar.classList.add('dimmed');
                if (bar.dataset.date === date) bar.classList.add('selected');
            });

            const label = document.getElementById('selected-date-label');
            if (date) {
                label.textContent = `(${date})`;
                filterByDate(date);
            } else {
                label.textContent = '';
                clearDateFilter();
            }
        }

        // Filter by date
        function filterByDate(date) {
            currentTimeFilter = date;
            updateMapFilter();
        }

        // Clear date filter
        function clearDateFilter() {
            currentTimeFilter = null;
            updateMapFilter();
        }

        // Update map filter based on time and layer toggles
        function updateMapFilter() {
            const typeFilters = [];
            if (activeTypes.building) typeFilters.push(['has', 'building']);
            if (activeTypes.highway) typeFilters.push(['has', 'highway']);
            if (activeTypes.waterway) typeFilters.push(['has', 'waterway']);

            let filter = typeFilters.length > 0 ? ['any', ...typeFilters] : ['==', 1, 0];

            if (currentTimeFilter) {
                // Filter features where timestamp starts with the selected date
                filter = ['all', filter, ['==', ['slice', ['get', 'timestamp'], 0, 10], currentTimeFilter]];
            }

            ['buildings-layer', 'highways-layer', 'waterways-layer'].forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.setFilter(layerId, filter);
                }
            });
        }

        // Setup time slider for animation
        function setupTimeSlider(editsByDate) {
            const slider = document.getElementById('time-slider');
            const timeDisplay = document.getElementById('current-time');
            const playBtn = document.getElementById('play-btn');

            // Create cumulative timestamps
            allTimestamps = editsByDate.map(d => d[0]);
            slider.max = allTimestamps.length;
            slider.value = allTimestamps.length;

            slider.addEventListener('input', () => {
                const idx = parseInt(slider.value);
                if (idx >= allTimestamps.length) {
                    timeDisplay.textContent = 'All dates';
                    clearTimeFilter();
                } else {
                    const date = allTimestamps[idx];
                    timeDisplay.textContent = `Up to ${date}`;
                    filterUpToDate(date);
                }
            });

            playBtn.addEventListener('click', toggleAnimation);
        }

        // Filter up to date (cumulative)
        function filterUpToDate(date) {
            const typeFilters = [];
            if (activeTypes.building) typeFilters.push(['has', 'building']);
            if (activeTypes.highway) typeFilters.push(['has', 'highway']);
            if (activeTypes.waterway) typeFilters.push(['has', 'waterway']);

            let filter = typeFilters.length > 0 ? ['any', ...typeFilters] : ['==', 1, 0];

            // Filter features where timestamp <= selected date
            filter = ['all', filter, ['<=', ['slice', ['get', 'timestamp'], 0, 10], date]];

            ['buildings-layer', 'highways-layer', 'waterways-layer'].forEach(layerId => {
                if (map.getLayer(layerId)) {
                    map.setFilter(layerId, filter);
                }
            });
        }

        // Clear time filter
        function clearTimeFilter() {
            updateMapFilter();
        }

        // Toggle animation
        function toggleAnimation() {
            const playBtn = document.getElementById('play-btn');
            const slider = document.getElementById('time-slider');

            if (isPlaying) {
                isPlaying = false;
                playBtn.textContent = '▶ Play';
                playBtn.classList.remove('playing');
                if (animationFrame) cancelAnimationFrame(animationFrame);
            } else {
                isPlaying = true;
                playBtn.textContent = '⏸ Pause';
                playBtn.classList.add('playing');

                // Reset to start if at end
                if (parseInt(slider.value) >= allTimestamps.length) {
                    slider.value = 0;
                }

                animateTimeline();
            }
        }

        // Animate timeline
        function animateTimeline() {
            if (!isPlaying) return;

            const slider = document.getElementById('time-slider');
            const timeDisplay = document.getElementById('current-time');
            const idx = parseInt(slider.value);

            if (idx >= allTimestamps.length) {
                isPlaying = false;
                document.getElementById('play-btn').textContent = '▶ Play';
                document.getElementById('play-btn').classList.remove('playing');
                timeDisplay.textContent = 'All dates';
                clearTimeFilter();
                return;
            }

            slider.value = idx + 1;
            const date = allTimestamps[idx];
            timeDisplay.textContent = `Up to ${date}`;
            filterUpToDate(date);

            // Highlight current bar
            document.querySelectorAll('.bar').forEach((bar, i) => {
                bar.classList.remove('selected', 'dimmed');
                if (i < idx) bar.classList.remove('dimmed');
                else if (i === idx) bar.classList.add('selected');
                else bar.classList.add('dimmed');
            });

            setTimeout(() => {
                animationFrame = requestAnimationFrame(animateTimeline);
            }, 800);
        }

        // Load map data when ready
        map.on('load', () => {
            document.getElementById('loading').style.display = 'none';

            // Try PMTiles first (works on GitHub Pages), fallback to GeoJSON for local dev
            loadOSMFeatures();
            loadHotProjects();

            // Update counts
            document.getElementById('count-building').textContent = '49,808';
            document.getElementById('count-highway').textContent = '1,025';
            document.getElementById('count-waterway').textContent = '3';
        });

        // Load OSM features - try PMTiles, fallback to GeoJSON
        async function loadOSMFeatures() {
            try {
                // Test if server supports range requests (needed for PMTiles)
                const testResponse = await fetch(PMTILES_URL, { method: 'HEAD' });
                const acceptRanges = testResponse.headers.get('Accept-Ranges');

                if (acceptRanges === 'bytes') {
                    // Use PMTiles (more efficient)
                    console.log('Using PMTiles source');
                    addPMTilesSource();
                } else {
                    throw new Error('Server does not support range requests');
                }
            } catch (e) {
                // Fallback to GeoJSON
                console.log('Falling back to GeoJSON source:', e.message);
                addGeoJSONSource();
            }
        }

        // Add PMTiles source
        function addPMTilesSource() {
            map.addSource('osm-features', {
                type: 'vector',
                url: 'pmtiles://' + PMTILES_URL
            });

            addFeatureLayers('osm_features');
        }

        // Add GeoJSON source (fallback)
        function addGeoJSONSource() {
            fetch('mozambique_flood_mapping.geojson')
                .then(r => r.json())
                .then(data => {
                    map.addSource('osm-features', {
                        type: 'geojson',
                        data: data
                    });

                    addFeatureLayers(null); // No source-layer for GeoJSON
                });
        }

        // Add feature layers
        function addFeatureLayers(sourceLayer) {
            const sourceLayerProp = sourceLayer ? { 'source-layer': sourceLayer } : {};

            // Buildings layer
            map.addLayer({
                id: 'buildings-layer',
                type: 'fill',
                source: 'osm-features',
                ...sourceLayerProp,
                filter: ['has', 'building'],
                paint: {
                    'fill-color': '#e74c3c',
                    'fill-opacity': 0.7,
                    'fill-outline-color': '#c0392b'
                }
            });

            // Highways layer
            map.addLayer({
                id: 'highways-layer',
                type: 'line',
                source: 'osm-features',
                ...sourceLayerProp,
                filter: ['has', 'highway'],
                paint: {
                    'line-color': '#3498db',
                    'line-width': 2,
                    'line-opacity': 0.8
                }
            });

            // Waterways layer
            map.addLayer({
                id: 'waterways-layer',
                type: 'line',
                source: 'osm-features',
                ...sourceLayerProp,
                filter: ['has', 'waterway'],
                paint: {
                    'line-color': '#2ecc71',
                    'line-width': 3,
                    'line-opacity': 0.8
                }
            });

            // Click handlers for popups
            map.on('click', 'buildings-layer', (e) => showPopup(e));
            map.on('click', 'highways-layer', (e) => showPopup(e));
            map.on('click', 'waterways-layer', (e) => showPopup(e));

            // Cursor changes
            ['buildings-layer', 'highways-layer', 'waterways-layer'].forEach(layer => {
                map.on('mouseenter', layer, () => map.getCanvas().style.cursor = 'pointer');
                map.on('mouseleave', layer, () => map.getCanvas().style.cursor = '');
            });
        }

        // Show popup
        function showPopup(e) {
            const props = e.features[0].properties;
            const html = `
                <strong>OSM ${props.osm_type} #${props.osm_id}</strong><br>
                <strong>Mapped:</strong> ${props.timestamp}<br>
                <strong>By:</strong> ${props.user}<br>
                <strong>Changeset:</strong> <a href="https://www.openstreetmap.org/changeset/${props.changeset}" target="_blank">${props.changeset}</a>
            `;
            new maplibregl.Popup()
                .setLngLat(e.lngLat)
                .setHTML(html)
                .addTo(map);
        }

        // Load HOT projects
        function loadHotProjects() {
            fetch('hot_projects.geojson')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('count-hot').textContent = data.features.length;

                    map.addSource('hot-projects', {
                        type: 'geojson',
                        data: data
                    });

                    map.addLayer({
                        id: 'hot-projects-layer',
                        type: 'line',
                        source: 'hot-projects',
                        paint: {
                            'line-color': '#f39c12',
                            'line-width': 3,
                            'line-dasharray': [2, 2],
                            'line-opacity': 0.9
                        }
                    });

                    map.addLayer({
                        id: 'hot-projects-fill',
                        type: 'fill',
                        source: 'hot-projects',
                        paint: {
                            'fill-color': '#f39c12',
                            'fill-opacity': 0.1
                        }
                    });

                    // Fit to bounds
                    const bounds = new maplibregl.LngLatBounds();
                    data.features.forEach(f => {
                        if (f.geometry.type === 'MultiPolygon') {
                            f.geometry.coordinates.forEach(poly => {
                                poly[0].forEach(coord => bounds.extend(coord));
                            });
                        } else if (f.geometry.type === 'Polygon') {
                            f.geometry.coordinates[0].forEach(coord => bounds.extend(coord));
                        }
                    });
                    hotProjectsBounds = bounds;
                    map.fitBounds(bounds, { padding: 50 });

                    // Click handler for HOT projects
                    map.on('click', 'hot-projects-fill', (e) => {
                        const props = e.features[0].properties;
                        new maplibregl.Popup()
                            .setLngLat(e.lngLat)
                            .setHTML(`
                                <strong>${props.name}</strong><br>
                                <strong>Project:</strong> <a href="${props.url}" target="_blank">#${props.projectId}</a><br>
                                <strong>Priority:</strong> ${props.priority}<br>
                                <strong>Progress:</strong> ${props.percentMapped}% mapped
                            `)
                            .addTo(map);
                    });
                });
        }

        // Layer toggle handlers
        document.querySelectorAll('.layer-toggle[data-layer]').forEach(toggle => {
            toggle.addEventListener('click', function() {
                const layer = this.dataset.layer;

                if (layer === 'hot-projects') {
                    hotProjectsVisible = !hotProjectsVisible;
                    this.classList.toggle('inactive', !hotProjectsVisible);
                    const visibility = hotProjectsVisible ? 'visible' : 'none';
                    if (map.getLayer('hot-projects-layer')) {
                        map.setLayoutProperty('hot-projects-layer', 'visibility', visibility);
                        map.setLayoutProperty('hot-projects-fill', 'visibility', visibility);
                    }
                } else {
                    activeTypes[layer] = !activeTypes[layer];
                    this.classList.toggle('inactive', !activeTypes[layer]);
                    updateMapFilter();
                }
            });
        });

        // Zoom to extent button (add custom control)
        class ZoomExtentControl {
            onAdd(map) {
                this._map = map;
                this._container = document.createElement('div');
                this._container.className = 'maplibregl-ctrl maplibregl-ctrl-group';
                this._container.innerHTML = '<button type="button" title="Zoom to full extent" style="font-size: 18px;">⌂</button>';
                this._container.querySelector('button').addEventListener('click', () => {
                    if (hotProjectsBounds) {
                        map.fitBounds(hotProjectsBounds, { padding: 50 });
                    }
                });
                return this._container;
            }
            onRemove() {
                this._container.parentNode.removeChild(this._container);
                this._map = undefined;
            }
        }
        map.addControl(new ZoomExtentControl(), 'top-left');
    </script>
</body>
</html>
